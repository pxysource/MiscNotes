# 1. 源代码结构

- `board`，开发板相关
- `common`，通用的函数
- `cpu`
- `disk`，硬盘接口程序
- `doc`
- `drivers`
- `dtt`，数字温度计和恒温器驱动程序
- `examples`
- `include`
- `lib_xxx`，`xxx`体系结构的通用文件
- `lib_generic`，通用的库函数
- `net`，各种网络协议
- `post`，上电自检程序
- `rtc`，实时时钟的驱动
- `tools`，制作`S-Record`、`U-Boot`格式映像的工具，如`mkimage`
- `fs`，文件系统

# 2. Makefile

## 2.1 配置

```shell
make O=../build/ smdk2410_config
```

### 2.1.1. 执行unconfig

删除之前配置生成的文件：

- `$(obj)include/config.h`
- `$(obj)include/config.mk`
- `$(obj)board/*/config.tmp`
- `$(obj)board/*/*/config.tmp`



### 2.1.2. 根据硬件属性进行配置

执行mkconfig

```shell
./mkconfig smdk2410 arm arm920t smdk2410 NULL s3c24x0
```

- `BOARD_NAME = smdk2410`

- `echo "Configuring for ${BOARD_NAME} board..."`

#### Create link to architecture specific headers

- `mkdir -p ${OBJTREE}/include`
- `mkdir -p ${OBJTREE}/include2`
- `cd ${OBJTREE}/include2`
- `rm -f asm`
- `ln -s ${SRCTREE}/include/asm-arm asm`
- `LNPREFIX="../../include2/asm/"`
- `cd ../include`
- `rm -rf asm-arm`
- `rm -f asm`
- `mkdir asm-arm`
- `ln -s asm-arm asm`
- `rm -f asm-arm/arch`
- `ln -s ${LNPREFIX}arch-s3c24x0 asm-arm/arch`
- `rm -f asm-arm/proc`
- `ln -s ${LNPREFIX}proc-armv asm-arm/proc`



#### Create include file for Make

- `echo "ARCH   = arm" >  config.mk`
- `echo "CPU    = arm920t" >> config.mk`
- `echo "BOARD  = smdk2410 " >> config.mk`
- `echo "SOC    = s3c24x0" >> config.mk`



#### Create board specific header file

- `> config.h`
- `echo "/* Automatically generated - do not edit */" >>config.h`
- `echo "#include <configs/smdk2410.h>" >>config.h`



## 2.2. 编译

```shell
make O=../build/ all
```

### 2.2.1. 变量

- `U_BOOT_VERSION = 1.1.6`

- `VERSION_FILE = $(obj)include/version_autogenerated.h`

- `HOSTARCH := x86_64`

- `HOSTOS := linux`

- `export  HOSTARCH HOSTOS`

- `BUILD_DIR := ../build/`

- `saved-output := $(BUILD_DIR)`

- `Attempt to create a output directory.即创建"../build/"目录`

- `Verify if it was successful.验证是否创建文件夹成功`

- `OBJTREE     := $(BUILD_DIR)`

- `SRCTREE     := $(CURDIR)`

- `TOPDIR      := $(SRCTREE)`

- `LNDIR       := $(OBJTREE)`

- `export  TOPDIR SRCTREE OBJTREE`

- `REMOTE_BUILD    := 1`

- `export REMOTE_BUILD`

- `obj := $(OBJTREE)/`

- `src := $(SRCTREE)/`

- `export obj src`

- load ARCH, BOARD, and CPU configuration
  - `include $(OBJTREE)/include/config.mk`:
    - `ARCH   = arm`
    - `CPU    = arm920t`
    - `BOARD  = smdk2410`
    - `SOC    = s3c24x0`
  - `export  ARCH CPU BOARD VENDOR SOC`
  
- `CROSS_COMPILE = arm-linux-`

- `export  CROSS_COMPILE`

- `load other configuration`

  - `include $(TOPDIR)/config.mk`
    - `BOARDDIR = $(BOARD)`
    - `CC  = $(CROSS_COMPILE)gcc`
  - `OBJS := $(obj)cpu/$(CPU)/start.o`

- `LIBS`

  - `LIBS  = lib_generic/libgeneric.a`
  - `LIBS += board/smdk2410/libsmdk2410.a`
  - `LIBS += cpu/arm920t/libarm920t.a`
  - `LIBS += cpu/arm920t/s3c24x0/libs3c24x0.a`
  - `LIBS += lib_arm/libarm.a`
  - `LIBS += fs/cramfs/libcramfs.a fs/fat/libfat.a fs/fdos/libfdos.a fs/jffs2/libjffs2.a fs/reiserfs/libreiserfs.a fs/ext2/libext2fs.a`
  - `LIBS += net/libnet.a`
  - `LIBS += disk/libdisk.a`
  - `LIBS += rtc/librtc.a`
  - `LIBS += dtt/libdtt.a`
  - `LIBS += drivers/libdrivers.a`
  - `LIBS += drivers/nand/libnand.a`
  - `LIBS += drivers/nand_legacy/libnand_legacy.a`
  - `LIBS += drivers/sk98lin/libsk98lin.a`
  - `LIBS += post/libpost.a post/cpu/libcpu.a`
  - `LIBS += common/libcommon.a`

- `LIBS := $(addprefix $(obj),$(LIBS))`

- `Add GCC lib`

  - ```makefile
    PLATFORM_LIBS += -L $(shell dirname `$(CC) $(CFLAGS) -print-libgcc-file-name`) -lgcc
    ```

- `SUBDIRS = tools examples post post/cpu`

- `__OBJS := $(subst $(obj),,$(OBJS))`

- `__LIBS := $(subst $(obj),,$(LIBS))`

### 2.2.2. ALL

`all:        $(ALL)`

- `ALL = $(obj)u-boot.srec $(obj)u-boot.bin $(obj)System.map $(U_BOOT_NAND)`
  - `$(obj)u-boot.srec`
    - $(obj)u-boot
      - `depend`
      - version
      - `...`
    - `$(OBJCOPY) ${OBJCFLAGS} -O srec $< $@`
  - `$(obj)u-boot.bin`
  - `$(obj)System.map`
  - `$(U_BOOT_NAND)`

## 2.3. Makefile语法

### Variable

#### 变量取值

参考《GNU make中文手册.pdf》 **2.9.1** 变量取值。

变量定义解析的规则如下：

**IMMEDIATE = DEFERRED** 

**IMMEDIATE ?= DEFERRED** 

**IMMEDIATE := IMMEDIATE** 

**IMMEDIATE += DEFERRED or IMMEDIATE** 

**define IMMEDIATE** 

​	**DEFERRED** 

**Endef** 

当变量使用追加符（+=）时，如果此前这个变量是一个简单变量（使用 :=定义的）则认为它

是立即展开的，其它情况时都被认为是“延后”展开的变量。

##### =

变量解析规则：**IMMEDIATE = DEFERRED**

`Makefile`:

```makefile
VARA = A
VARB = $(VARA) B
VARA = AA

all:
    @echo "VARB = $(VARB)"
```

执行`make`

```shell
linux@ubuntu:~/linux_learn/makefile_make/test$ make
VARB = AA B
```

`=`在`Makefile`中是延后展开的：将变量A赋值给变量B，假如变量A经过多次赋值，赋值给变量B的值是对变量A的最后一次赋值（即会将变量A的值全部展开）。

##### :=

变量解析规则：**IMMEDIATE = IMMEDIATE **

`Makefile`:

```makefile
VARA = A
VARB := $(VARA) B
VARA = AA

all:
    @echo "VARB = $(VARB)"
```

执行`make`

```shell
linux@ubuntu:~/linux_learn/makefile_make/test$ make
VARB = A B
```

`:=`在`Makefile`中是立即展开的：将变量A赋值给变量B，赋值给变量B的值是当前语句之前对变量A的最后一次赋值（即不会将变量A的值全部展开）。

##### ?=

变量解析规则：**IMMEDIATE ?= DEFERRED**

`Makefile`:

```makefile
VARA = A
VARB ?= $(VARA) B
VARC = C
VARA = AA
VARC ?= CC

all:
    @echo "VARB = $(VARB)"
    @echo "VARC = $(VARC)"
```

执行`make`

```shell
linux@ubuntu:~/linux_learn/makefile_make/test$ make
VARB = AA B
VARC = C
```

`?=`在`Makefile`中是延迟展开的：

- 如果没有定义变量，才会定义变量并为变量赋值。
- 将变量A赋值给变量B，假如变量A经过多次赋值，赋值给变量B的值是对变量A的最后一次赋值（即会将变量A的值全部展开）。

##### +=

变量解析规则：**IMMEDIATE += DEFERRED or IMMEDIATE**

`Makefile`:

```makefile
VARA = A
VARB := $(VARA) B
VARC := C
VARC += $(VARA) + $(VARB)
VARD = D
VARD += $(VARA) + $(VARB)
VARA = AA
VARB = BB

all:
    @echo "VARC = $(VARC)"
    @echo "VARD = $(VARD)"
```

执行`make`

```shell
linux@ubuntu:~/linux_learn/makefile_make/test$ make
VARC = C A + A B
VARD = D AA + BB
```

当变量使用追加符（+=）时，如果此前这个变量是一个简单变量（使用 :=定义的）则认为它

是立即展开的，其它情况时都被认为是“延后”展开的变量。

### Function

#### origin

参考《GNU make中文手册.pdf》 **7.9 origin**函数。

获取和此变量（参数）相关的信息，告诉我们这个变量的出处（定义方式）。

函数的返回情况`command line`和`file`测试：

`Makefile`:

```makefile
ifdef O
ifeq ("$(origin O)", "command line")
BUILD_DIR := $(O)
endif
endif

VARA = A
ifdef VARA
ifeq ("$(origin VARA)", "file")
VARB := $(VARA) B
endif
endif

all:
    @echo "BUILD_DIR = $(BUILD_DIR)"
    @echo "VARB = $(VARB)"
```

执行`make`

```shell
linux@ubuntu:~/linux_learn/makefile_make/function/origin$ make O=`pwd`
BUILD_DIR = /home/linux/linux_learn/makefile_make/function/origin
VARB = A B
```

## 2.4. Shell命令笔记

### uname

#### uname -m

> print the machine hardware name

```shell
linux@ubuntu:~/linux_learn/shell_script/test$ uname -m
x86_64
```

#### uname -s

>print the kernel name

```shell
linux@ubuntu:~/linux_learn/shell_command/test$ uname -s
Linux
```

### sed

功能强大的流式文本编辑器

#### sed -e 's/regexp/replacement/'

替换字符串

>  Attempt  to  match  regexp  against the pattern space.  If successful, replace that portion matched with replacement.
>  The replacement may contain the special character & to refer to that portion of the pattern space which matched,  and
>  the special escapes \1 through \9 to refer to the corresponding matching sub-expressions in the regexp.

```shell
#!/bin/bash
#File Name   : basic.sh
#Author      : panxingyuan
#Email       : panxingyuan1@163.com
#Create Time : 2023-01-08 14:12:10
#Description : Basic usage of the sed.

HOSTARCH1=`echo i.86 | sed -e 's/i.86/i386/'`
HOSTARCH2=`echo 86 | sed -e 's/i.86/i386/'`

echo "HOSTARCH1 = $HOSTARCH1"
echo "HOSTARCH2 = $HOSTARCH2"
```

运行脚本：

```shell
linux@ubuntu:~/linux_learn/shell_command/sed_learn$ ./basic.sh
HOSTARCH1 = i386
HOSTARCH2 = 86
```

### tr

将字符进行替换压缩和删除

#### tr '[:upper:]' '[:lower:]'

转换字符串的大小写

```shell
linux@ubuntu:~/linux_learn/shell_command/test$ echo `uname -s | tr [:upper:] [:lower:]`
linux
```


